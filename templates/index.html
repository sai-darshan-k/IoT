<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environmental Monitoring System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.37.0/apexcharts.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --accent-dark: #2980b9;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --text: #333;
            --text-light: #7f8c8d;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --card-radius: 16px;
            --transition: all 0.3s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 1.5rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 1.5rem;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
        }

        .dashboard-title {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary);
        }

        .dashboard-info {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .dashboard-time, .dashboard-date {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .dashboard-date {
            font-weight: 500;
            color: var(--primary);
        }

        .dashboard-status {
            padding: 0.5rem 1rem;
            background: var(--success);
            color: white;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: minmax(100px, auto);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            overflow: hidden;
            transition: var(--transition);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .card-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light);
            color: var(--primary);
            font-size: 1.2rem;
        }

        .temp-card { grid-column: span 3; grid-row: span 1; }
        .humidity-card { grid-column: span 3; grid-row: span 1; }
        .rain-card { grid-column: span 6; grid-row: span 2; }
        .soil-card { grid-column: span 6; grid-row: span 2; }
        .water-card { grid-column: span 6; grid-row: span 2; }
        .rain-intensity-card { grid-column: span 6; grid-row: span 2; }

        .gauge-container {
            position: relative;
            margin: auto;
            width: 200px;
            height: 120px;
        }

        .gauge-value {
            position: absolute;
            bottom: 0;
            width: 100%;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .gauge-label {
            position: absolute;
            bottom: -25px;
            width: 100%;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .rain-info {
            display: flex;
            height: 100%;
            flex-direction: column;
        }

        .rain-status {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .rain-active { background-color: var(--danger); color: white; }
        .rain-inactive { background-color: var(--success); color: white; }

        .rain-image {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .rain-image img {
            max-width: 120px;
            max-height: 120px;
        }

        .chart-container {
            flex-grow: 1;
            width: 100%;
            min-height: 200px;
            position: relative;
            margin-top: 1rem;
        }

        .water-container {
            position: relative;
            margin: 1rem auto;
            width: 200px;
            height: 200px;
        }

        .water-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 6px solid var(--light);
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        .water-fill {
            position: absolute;
            width: 100%;
            bottom: 0;
            background: var(--accent);
            transition: height 1s ease-in-out;
        }

        .water-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1;
        }

        .water-percentage {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary);
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
        }

        .water-status {
            font-size: 1rem;
            color: var(--text-light);
            font-weight: 500;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
        }

        @keyframes wave {
            0% { transform: translateX(-100%) }
            100% { transform: translateX(100%) }
        }

        .water-wave {
            position: absolute;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: wave 3s linear infinite;
        }

        /* Weather icons */
        .wi {
            display: inline-block;
            font-size: 2rem;
            margin-right: 0.5rem;
        }

        .big-value {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 1rem 0;
            text-align: center;
        }

        .trend-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .trend-up { color: var(--danger); }
        .trend-down { color: var(--success); }

        .card-footer {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            padding-top: 1rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.6);
            padding: 0.8rem;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: var(--transition);
        }

        .status-item:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .status-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.3rem;
        }

        .temperature-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            .temp-card, .humidity-card { grid-column: span 3; }
            .rain-card, .soil-card, .water-card, .rain-intensity-card { grid-column: span 6; }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .temp-card, .humidity-card, .rain-card, .soil-card, .water-card, .rain-intensity-card { 
                grid-column: span 1; 
            }
            .dashboard-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            .dashboard-info {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Animated background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: rgba(52, 152, 219, 0.05);
            animation: float 15s infinite ease-in-out;
        }

        .bg-circle:nth-child(1) {
            width: 300px;
            height: 300px;
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .bg-circle:nth-child(2) {
            width: 200px;
            height: 200px;
            top: 60%;
            left: 80%;
            animation-delay: 3s;
        }

        .bg-circle:nth-child(3) {
            width: 350px;
            height: 350px;
            top: 40%;
            left: 40%;
            animation-delay: 6s;
        }

        .bg-circle:nth-child(4) {
            width: 250px;
            height: 250px;
            top: 80%;
            left: 20%;
            animation-delay: 9s;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(30px, 30px) rotate(180deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="animated-bg">
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
    </div>

    <div class="dashboard-header">
        <h1 class="dashboard-title">Environmental Monitoring System</h1>
        <div class="dashboard-info">
            <div>
                <div class="dashboard-time" id="current-time">--:--:--</div>
                <div class="dashboard-date" id="current-date">--, -- --- ----</div>
            </div>
            <div class="dashboard-status">System Online</div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card temp-card">
            <div class="card-header">
                <h3 class="card-title">Temperature</h3>
                <div class="card-icon">üå°Ô∏è</div>
            </div>
            <div class="temperature-box">
                <div class="big-value"><span id="temp-value">--</span>¬∞C</div>
                <div class="trend-indicator" id="temp-trend">--</div>
            </div>
            <div class="card-footer">
                <span>Updated: <span id="temp-updated">--:--</span></span>
                <span>Today's Avg: <span id="temp-avg">--</span>¬∞C</span>
            </div>
        </div>

        <div class="card humidity-card">
            <div class="card-header">
                <h3 class="card-title">Humidity</h3>
                <div class="card-icon">üíß</div>
            </div>
            <div class="temperature-box">
                <div class="big-value"><span id="humidity-value">--</span>%</div>
                <div class="trend-indicator" id="humidity-trend">--</div>
            </div>
            <div class="card-footer">
                <span>Updated: <span id="humidity-updated">--:--</span></span>
                <span>Today's Avg: <span id="humidity-avg">--</span>%</span>
            </div>
        </div>

        <div class="card rain-card">
            <div class="card-header">
                <h3 class="card-title">Rain Detection</h3>
                <div class="card-icon">üåßÔ∏è</div>
            </div>
            <div class="rain-info">
                <div id="rain-status" class="rain-status">No Data</div>
                <div class="rain-image" id="rain-image"></div>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-value" id="rain-day-count">--</div>
                        <div class="status-label">Rain Events Today</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="rain-duration">--</div>
                        <div class="status-label">Last Duration</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card rain-intensity-card">
            <div class="card-header">
                <h3 class="card-title">Rain Intensity</h3>
                <div class="card-icon">üìä</div>
            </div>
            <div class="chart-container">
                <div id="rainIntensityChart"></div>
            </div>
            <div class="card-footer">
                <span>Max Intensity: <span id="max-intensity">--</span></span>
                <span>Average: <span id="avg-intensity">--</span></span>
            </div>
        </div>

        <div class="card soil-card">
            <div class="card-header">
                <h3 class="card-title">Soil Moisture</h3>
                <div class="card-icon">üå±</div>
            </div>
            <div class="chart-container">
                <div id="soilChart"></div>
            </div>
            <div class="card-footer">
                <span>Status: <span id="soil-status">--</span></span>
                <span>Trend: <span id="soil-trend">--</span></span>
            </div>
        </div>

        <div class="card water-card">
            <div class="card-header">
                <h3 class="card-title">Water Level</h3>
                <div class="card-icon">üåä</div>
            </div>
            <div class="water-container">
                <div class="water-circle">
                    <div class="water-fill" id="water-fill">
                        <div class="water-wave"></div>
                    </div>
                </div>
                <div class="water-text">
                    <div class="water-percentage" id="water-percentage">--</div>
                    <div class="water-status" id="water-status">No Data</div>
                </div>
            </div>
            <div class="card-footer">
                <span>Updated: <span id="water-updated">--:--</span></span>
                <span>Change: <span id="water-change">--</span></span>
            </div>
        </div>
    </div>

    <script>
    // Constants for water level thresholds
    const WATER_LEVELS = {
        THRESHOLDS: {
            VERY_WET: 2500,
            SHALLOW_WET: 1700,
            MODERATELY_WET: 1300
        },
        PERCENTAGES: {
            VERY_WET: 0,
            SHALLOW_WET: 40,
            MODERATELY_WET: 75,
            DEEP_WET: 95
        }
    };

    // Store historical data for trends
    const historyData = {
        temperature: [],
        humidity: [],
        rainIntensity: [],
        soilMoisture: [],
        waterLevel: [],
        rainEvents: 0,
        lastRainDuration: 0,
        rainStartTime: null
    };

    // Initialize charts
    const rainIntensityChart = new ApexCharts(document.getElementById('rainIntensityChart'), {
        series: [{
            name: 'Rain Intensity',
            data: []
        }],
        chart: {
            height: 200,
            type: 'area',
            toolbar: {
                show: false
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            },
            sparkline: {
                enabled: false
            }
        },
        stroke: {
            curve: 'smooth',
            width: 3
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.3,
                stops: [0, 90, 100],
                colorStops: [
                    {
                        offset: 0,
                        color: '#3498db',
                        opacity: 0.7
                    },
                    {
                        offset: 100,
                        color: '#2ecc71',
                        opacity: 0.3
                    }
                ]
            }
        },
        markers: {
            size: 0
        },
        grid: {
            show: false
        },
        xaxis: {
            categories: [],
            labels: {
                show: true,
                style: {
                    fontSize: '10px'
                }
            }
        },
        yaxis: {
            min: 0,
            labels: {
                style: {
                    fontSize: '10px'
                }
            }
        },
        tooltip: {
            x: {
                format: 'HH:mm:ss'
            }
        },
        theme: {
            mode: 'light'
        }
    });
    rainIntensityChart.render();

    const soilChart = new ApexCharts(document.getElementById('soilChart'), {
        series: [{
            name: 'Soil Moisture',
            data: []
        }],
        chart: {
            height: 200,
            type: 'line',
            toolbar: {
                show: false
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            },
            sparkline: {
                enabled: false
            }
        },
        stroke: {
            curve: 'smooth',
            width: 3
        },
        colors: ['#e67e22'],
        markers: {
            size: 4,
            colors: ['#e67e22'],
            strokeColors: '#fff',
            strokeWidth: 2
        },
        grid: {
            show: false
        },
        xaxis: {
            categories: [],
            labels: {
                show: true,
                style: {
                    fontSize: '10px'
                }
            }
        },
        yaxis: {
            min: 0,
            labels: {
                style: {
                    fontSize: '10px'
                }
            }
        },
        tooltip: {
            x: {
                format: 'HH:mm:ss'
            }
        },
        theme: {
            mode: 'light'
        }
    });
    soilChart.render();

    // Helper functions
    function getWaterStatus(value) {
        if (value >= WATER_LEVELS.THRESHOLDS.VERY_WET) return 'Dry';
        if (value >= WATER_LEVELS.THRESHOLDS.SHALLOW_WET) return 'Shallow Wet';
        if (value >= WATER_LEVELS.THRESHOLDS.MODERATELY_WET) return 'Moderately Wet';
        return 'Deep Wet';
    }

    function getWaterColor(value) {
        if (value >= WATER_LEVELS.THRESHOLDS.VERY_WET) return '#3498db';
        if (value >= WATER_LEVELS.THRESHOLDS.SHALLOW_WET) return '#2980b9';
        if (value >= WATER_LEVELS.THRESHOLDS.MODERATELY_WET) return '#1f618d';
        return '#154360';
    }

    function getWaterPercentage(value) {
        if (value >= WATER_LEVELS.THRESHOLDS.VERY_WET) return WATER_LEVELS.PERCENTAGES.VERY_WET;
        if (value >= WATER_LEVELS.THRESHOLDS.SHALLOW_WET) return WATER_LEVELS.PERCENTAGES.SHALLOW_WET;
        if (value >= WATER_LEVELS.THRESHOLDS.MODERATELY_WET) return WATER_LEVELS.PERCENTAGES.MODERATELY_WET;
        return WATER_LEVELS.PERCENTAGES.DEEP_WET;
    }

    function getSoilStatus(value) {
        if (value > 2500) return 'Very Dry';
        if (value > 2000) return 'Dry';
        if (value > 1500) return 'Slightly Dry';
        if (value > 1000) return 'Moist';
        return 'Wet';
    }

    function getTrendIndicator(currentValue, previousValues, type) {
        if (previousValues.length < 2) return '‚Äî';
        
        const avgPrevious = previousValues.slice(-3, -1).reduce((a, b) => a + b, 0) / 2;
        const diff = currentValue - avgPrevious;
        const percentage = Math.abs((diff / avgPrevious) * 100).toFixed(1);
        
        if (Math.abs(diff) < 0.5) return '‚Äî';
        
        if (type === 'temp' || type === 'water') {
            // For temperature and water, rising is visualized with an up arrow
            if (diff > 0) return `<span class="trend-up">‚Üë ${percentage}%</span>`;
            return `<span class="trend-down">‚Üì ${percentage}%</span>`;
        } else {
            // For humidity and soil moisture, rising is generally better
            if (diff > 0) return `<span class="trend-down">‚Üë ${percentage}%</span>`;
            return `<span class="trend-up">‚Üì ${percentage}%</span>`;
        }
    }

    function calculateAverage(arr) {
        if (arr.length === 0) return 0;
        return (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1);
    }

    function calculateMax(arr) {
        if (arr.length === 0) return 0;
        return Math.max(...arr).toFixed(1);
    }

    function convertSoilMoistureToWaterLevel(soilMoisture) {
        return soilMoisture; // Direct pass-through as per your existing code
    }

    function updateWaterLevel(value) {
        if (value == null || isNaN(value)) {
            document.getElementById('water-percentage').textContent = '--%';
            document.getElementById('water-status').textContent = 'No Data';
            document.getElementById('water-fill').style.height = '0%';
            document.getElementById('water-fill').style.backgroundColor = '#ecf0f1';
            return;
        }

        const percentage = getWaterPercentage(value);
        const status = getWaterStatus(value);
        const color = getWaterColor(value);

        const waterFill = document.getElementById('water-fill');
        const waterPercentage = document.getElementById('water-percentage');
        const waterStatus = document.getElementById('water-status');

        waterFill.style.height = `${percentage}%`;
        waterFill.style.backgroundColor = color;
        waterPercentage.textContent = `${percentage}%`;
        waterStatus.textContent = status;
        
        // Update water trend and change
        document.getElementById('water-updated').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        if (historyData.waterLevel.length > 1) {
            const lastValue = historyData.waterLevel[historyData.waterLevel.length - 2];
            const change = percentage - getWaterPercentage(lastValue);
            document.getElementById('water-change').textContent = (change >= 0 ? '+' : '') + change + '%';
        }
    }

    function updateRainStatus(isRainDetected) {
        const rainStatus = document.getElementById('rain-status');
        const rainImage = document.getElementById('rain-image');
        const currentHour = new Date().getHours();
        const currentTime = new Date();

        if (isRainDetected) {
            rainStatus.innerHTML = 'Rain Detected';
            rainStatus.className = 'rain-status rain-active';
            rainImage.innerHTML = '<img src="https://media.tenor.com/YefQKTdi3hUAAAAj/rafsdesign-rafsdesigns.gif" alt="Rain" width="120" height="120">';
            
            // Track rain events
            if (historyData.rainStartTime === null) {
                historyData.rainStartTime = currentTime;
                historyData.rainEvents++;
                document.getElementById('rain-day-count').textContent = historyData.rainEvents;
            }
        } else {
            rainStatus.innerHTML = 'No Rain';
            rainStatus.className = 'rain-status rain-inactive';
            
            if (currentHour >= 6 && currentHour < 18) {
                rainImage.innerHTML = '<img src="https://media1.tenor.com/m/gUKy0QmrNHIAAAAC/sun-sunlight.gif" alt="Sunlight" width="120" height="120">';
            } else {
                rainImage.innerHTML = '<img src="https://media.tenor.com/DTIl6DWhrZwAAAAj/moon-spacedoodles.gif" alt="Moonlight" width="120" height="120">';
            }
            
            // Calculate rain duration if it was raining
            if (historyData.rainStartTime !== null) {
                const duration = Math.round((currentTime - historyData.rainStartTime) / 60000); // in minutes
                historyData.lastRainDuration = duration;
                document.getElementById('rain-duration').textContent = duration + ' min';
                historyData.rainStartTime = null;
            }
        }
    }

    function updateCharts(time, data) {
        // Update rain intensity chart
        if (data.rain_intensity !== null) {
            const series = rainIntensityChart.w.globals.series[0];
            const categories = rainIntensityChart.w.globals.categoryLabels;
            
            // Keep only the last 10 data points
            if (series.length >= 10) {
                series.shift();
                categories.shift();
            }
            
            series.push(data.rain_intensity);
            categories.push(time);
            
            rainIntensityChart.updateOptions({
                series: [{
                    data: series
                }],
                xaxis: {
                    categories: categories
                }
            });
            
            // Update max and avg intensity
            document.getElementById('max-intensity').textContent = calculateMax(series);
            document.getElementById('avg-intensity').textContent = calculateAverage(series);
        }
        
        if (data.soil_moisture !== null) {
        const series = soilChart.w.globals.series[0];
        const categories = soilChart.w.globals.categoryLabels;
        
        // Keep only the last 10 data points
        if (series.length >= 10) {
            series.shift();
            categories.shift();
        }
        
        series.push(data.soil_moisture);
        categories.push(time);
        
        soilChart.updateOptions({
            series: [{
                data: series
            }],
            xaxis: {
                categories: categories
            }
        });
        
        // Update soil status and trend
        document.getElementById('soil-status').textContent = getSoilStatus(data.soil_moisture);
        historyData.soilMoisture.push(data.soil_moisture);
        if (historyData.soilMoisture.length > 10) historyData.soilMoisture.shift();
        document.getElementById('soil-trend').innerHTML = getTrendIndicator(
            data.soil_moisture, 
            historyData.soilMoisture, 
            'soil'
        );
    }
}

async function updateDashboard() {
    try {
        const response = await fetch('/sensor-data');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        
        const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        
        // Update temperature
        if (data.temperature !== null) {
            document.getElementById('temp-value').textContent = data.temperature.toFixed(1);
            document.getElementById('temp-updated').textContent = currentTime.slice(0, -3); // Remove seconds
            
            // Store temperature for trend calculation
            historyData.temperature.push(data.temperature);
            if (historyData.temperature.length > 10) historyData.temperature.shift();
            
            // Update temperature trend
            document.getElementById('temp-trend').innerHTML = getTrendIndicator(
                data.temperature, 
                historyData.temperature, 
                'temp'
            );
            
            // Update average temperature
            document.getElementById('temp-avg').textContent = calculateAverage(historyData.temperature);
        }
        
        // Update humidity
        if (data.humidity !== null) {
            document.getElementById('humidity-value').textContent = data.humidity.toFixed(1);
            document.getElementById('humidity-updated').textContent = currentTime.slice(0, -3); // Remove seconds
            
            // Store humidity for trend calculation
            historyData.humidity.push(data.humidity);
            if (historyData.humidity.length > 10) historyData.humidity.shift();
            
            // Update humidity trend
            document.getElementById('humidity-trend').innerHTML = getTrendIndicator(
                data.humidity, 
                historyData.humidity, 
                'humidity'
            );
            
            // Update average humidity
            document.getElementById('humidity-avg').textContent = calculateAverage(historyData.humidity);
        }
        
        // Update rain detection status
        if (data.rain_detected !== null) {
            updateRainStatus(data.rain_detected);
        }
        
        // Update charts
        updateCharts(currentTime, data);
        
        // Update water level
        if (data.soil_moisture !== null) {
            const waterLevel = convertSoilMoistureToWaterLevel(data.soil_moisture);
            historyData.waterLevel.push(waterLevel);
            if (historyData.waterLevel.length > 10) historyData.waterLevel.shift();
            updateWaterLevel(waterLevel);
        }
        
    } catch (error) {
        console.error('Error fetching sensor data:', error);
    }
}

// Update date and time
function updateDateTime() {
    const now = new Date();
    document.getElementById('current-time').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
    document.getElementById('current-date').textContent = now.toLocaleDateString([], {weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'});
}

// Initialize dashboard
function initDashboard() {
    updateDateTime();
    updateDashboard();
    
    // Set interval for time updates (every second)
    setInterval(updateDateTime, 1000);
    
    // Set interval for dashboard updates (every 5 seconds)
    const updateInterval = setInterval(updateDashboard, 5000);
    
    // Pause updates when tab is not visible to save resources
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            clearInterval(updateInterval);
        } else {
            updateDashboard();
            setInterval(updateDashboard, 5000);
        }
    });
}

// Run initialization
window.addEventListener('DOMContentLoaded', initDashboard);
    </script>
    </body>
    </html>